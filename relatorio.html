<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - Burger na Churrasqueira</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Oswald:wght@500;700&display=swap');
        :root {
            --primary-color: #FFC107; --secondary-color: #D32F2F; --dark-bg: #212121;
            --light-text: #FFFFFF; --card-bg: #424242; --green: #4CAF50; --blue: #2196F3; --grey: #9E9E9E;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--dark-bg); color: var(--light-text); }
        .header { background-color: var(--card-bg); padding: 20px; text-align: center; border-bottom: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-family: 'Oswald', sans-serif; margin: 0; text-transform: uppercase; }
        #logout-btn { background-color: var(--secondary-color); color: var(--light-text); border: none; padding: 10px 15px; font-size: 0.9em; border-radius: 5px; cursor: pointer; }
        
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; max-width: 400px; padding: 20px; text-align: center; margin: 0 auto; }
        .login-box { width: 100%; }
        #login-container h1 { font-family: 'Oswald', sans-serif; color: var(--primary-color); }
        #login-form { display: flex; flex-direction: column; gap: 15px; }
        #login-form input { padding: 15px; border-radius: 5px; border: 1px solid #616161; background-color: var(--card-bg); color: var(--light-text); font-size: 1em; }
        #login-form button { background-color: var(--secondary-color); color: var(--light-text); border: none; padding: 15px; font-size: 1.1em; font-weight: bold; border-radius: 5px; cursor: pointer; }
        #login-error { color: var(--secondary-color); margin-top: 15px; font-weight: bold; min-height: 20px; }

        #main-report { display: none; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .controls { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px; padding: 20px; background-color: var(--card-bg); border-radius: 10px; }
        .controls label { font-weight: bold; font-family: 'Oswald', sans-serif; font-size: 1.2em; }
        .controls input[type="date"] { padding: 8px; border-radius: 5px; border: 2px solid var(--primary-color); background-color: #333; color: white; font-family: 'Roboto', sans-serif; }
        #export-pdf-btn { background-color: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        
        .cash-management { background-color: var(--card-bg); border-radius: 10px; padding: 20px; margin-bottom: 30px; border-left: 5px solid var(--green); }
        .cash-management h2 { font-family: 'Oswald', sans-serif; text-align: center; margin-top: 0; color: var(--primary-color); }
        .cash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; align-items: flex-end; }
        .cash-field { display: flex; flex-direction: column; }
        .cash-field label { font-size: 0.9em; color: #ccc; margin-bottom: 5px; }
        .cash-field input { width: calc(100% - 22px); padding: 10px; border-radius: 5px; border: 1px solid #616161; background-color: #333; color: white; font-size: 1.2em; font-weight: bold; }
        .cash-field span { font-size: 1.8em; font-weight: bold; padding: 10px 0; }
        #cash-diff.positive { color: var(--green); }
        #cash-diff.negative { color: var(--secondary-color); }
        #save-cash-btn { background-color: var(--green); color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; grid-column: 1 / -1; margin-top: 10px; }
        .prev-day-cash { font-size: 0.9em; text-align: center; margin-bottom: 15px; padding: 10px; background-color: #333; border-radius: 5px; display: none; }
        #toggle-prev-day { text-decoration: underline; cursor: pointer; color: var(--blue); display: block; text-align: center; margin-bottom: 15px; font-size: 0.9em;}

        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .summary-card { background-color: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center; border-left: 5px solid var(--primary-color); }
        .summary-card h3 { margin-top: 0; font-family: 'Oswald', sans-serif; font-size: 1.2em; color: #ccc; }
        .summary-card p { font-size: 2.2em; margin: 10px 0 0 0; font-weight: bold; color: var(--light-text); }
        #total-sales { color: var(--green); }
        #cancelled-orders { color: var(--secondary-color); }
        .chart-container { position: relative; min-height: 400px; width: 100%; }
        .dual-chart-container { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .bestsellers-container { grid-column: 1 / -1; }
        #no-data-message { text-align: center; font-size: 1.2em; color: var(--grey); padding: 40px; display: none; grid-column: 1 / -1; }

        #print-version { display: none; font-family: Arial, sans-serif; color: #000; width: 210mm; padding: 15mm; box-sizing: border-box; }
        #print-version h1 { text-align: center; font-size: 18pt; overflow-wrap: break-word; line-height: 1.2; }
        #print-version h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; font-size: 14pt; }
        #print-version table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10pt; table-layout: fixed; }
        #print-version th, #print-version td { border: 1px solid #ddd; padding: 8px; text-align: left; overflow-wrap: break-word; }
        #print-version th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="login-box"><h1>üìä Relat√≥rios üìä</h1><form id="login-form"><input type="email" id="email" placeholder="Seu e-mail" required><input type="password" id="password" placeholder="Sua senha" required><button type="submit">Acessar</button></form><p id="login-error"></p></div>
    </div>
    <div id="main-report">
        <div id="report-content">
            <header class="header"><h1>Relat√≥rio de Vendas</h1><button id="logout-btn">Sair</button></header>
            <div class="container">
                <div class="controls">
                    <label for="report-date">Selecione o dia:</label>
                    <input type="date" id="report-date">
                    <button id="export-pdf-btn">Exportar PDF üìÑ</button>
                </div>
                <div class="cash-management">
                    <h2>Caixa do Dia</h2>
                    <a id="toggle-prev-day">Mostrar/Ocultar Fechamento Anterior</a>
                    <div class="prev-day-cash" id="prev-day-cash-info">Fechamento do dia anterior: <strong>R$ <span id="prev-day-closing">0.00</span></strong></div>
                    <div class="cash-grid">
                        <div class="cash-field"><label for="cash-start">Caixa Inicial (Abertura)</label><input type="number" id="cash-start" placeholder="0.00"></div>
                        <div class="cash-field"><label>+ Vendas em Dinheiro</label><span id="cash-sales">R$ 0.00</span></div>
                        <div class="cash-field"><label>= Valor Esperado</label><span id="cash-expected">R$ 0.00</span></div>
                        <div class="cash-field"><label for="cash-end">Caixa Final (Fechamento)</label><input type="number" id="cash-end" placeholder="0.00"></div>
                        <div class="cash-field"><label>Diferen√ßa (Quebra)</label><span id="cash-diff">R$ 0.00</span></div>
                        <button id="save-cash-btn">Salvar Abertura/Fechamento do Dia</button>
                    </div>
                </div>
                <div class="report-grid">
                    <div class="summary-card"><h3>Total Vendido</h3><p id="total-sales">R$ 0,00</p></div>
                    <div class="summary-card"><h3>Pedidos V√°lidos</h3><p id="total-orders">0</p></div>
                    <div class="summary-card"><h3>Pedidos Cancelados</h3><p id="cancelled-orders">0</p></div>
                    <div class="summary-card"><h3>Ticket M√©dio</h3><p id="average-ticket">R$ 0,00</p></div>
                    <div class="summary-card chart-container bestsellers-container">
                        <h3>üèÜ Itens Mais Vendidos</h3>
                        <canvas id="bestsellers-chart"></canvas>
                    </div>
                    <div class="dual-chart-container">
                        <div class="summary-card">
                            <h3>üöö Entregas vs Retiradas</h3>
                            <div class="chart-container" style="min-height: 350px;">
                                <canvas id="delivery-chart"></canvas>
                            </div>
                        </div>
                        <div class="summary-card">
                            <h3>üí≥ Formas de Pagamento</h3>
                            <div class="chart-container" style="min-height: 350px;">
                                <canvas id="payment-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <p id="no-data-message">Nenhum pedido encontrado para esta data.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="print-version">
        <h1>Relat√≥rio de Vendas<br>Burger na Churrasqueira</h1>
        <h2>Resumo do Dia: <span id="print-date"></span></h2>
        <table>
            <tr><th>M√©trica</th><th>Valor</th></tr>
            <tr><td>Total Vendido (R$)</td><td id="print-total-sales"></td></tr>
            <tr><td>Pedidos V√°lidos</td><td id="print-total-orders"></td></tr>
            <tr><td>Pedidos Cancelados</td><td id="print-cancelled-orders"></td></tr>
            <tr><td>Ticket M√©dio (R$)</td><td id="print-average-ticket"></td></tr>
        </table>
        <h2>Distribui√ß√£o de Pagamentos</h2>
        <table>
            <tr><th>Forma de Pagamento</th><th>Quantidade</th></tr>
            <tr><td>PIX</td><td id="print-pix-count"></td></tr>
            <tr><td>Cart√£o na Entrega</td><td id="print-card-count"></td></tr>
            <tr><td>Dinheiro</td><td id="print-money-count"></td></tr>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBWzm7lBAgMq1iCBqWGjIDXPs1FmmsZohc", authDomain: "cardapio-burger-churrasqueira.firebaseapp.com", projectId: "cardapio-burger-churrasqueira", storageBucket: "cardapio-burger-churrasqueira.appspot.com", messagingSenderId: "474684824937", appId: "1:474684824937:web:50d18f8bd6b9e91f6871f8" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginContainer = document.getElementById('login-container');
        const mainReport = document.getElementById('main-report');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const dateInput = document.getElementById('report-date');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const noDataMessage = document.getElementById('no-data-message');
        const reportGrid = document.querySelector('.report-grid');
        let paymentChart = null, bestsellersChart = null, deliveryChart = null;
        
        const cashStartInput = document.getElementById('cash-start');
        const cashSalesSpan = document.getElementById('cash-sales');
        const cashExpectedSpan = document.getElementById('cash-expected');
        const cashEndInput = document.getElementById('cash-end');
        const cashDiffSpan = document.getElementById('cash-diff');
        const saveCashBtn = document.getElementById('save-cash-btn');
        const togglePrevDayBtn = document.getElementById('toggle-prev-day');
        const prevDayInfo = document.getElementById('prev-day-cash-info');
        const prevDayClosingSpan = document.getElementById('prev-day-closing');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const loginButton = e.target.querySelector('button');
            loginButton.textContent = 'Acessando...';
            loginError.textContent = '';
            signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
                .catch(err => {
                    loginError.textContent = 'E-mail ou senha incorretos.';
                    loginButton.textContent = 'Acessar';
                });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginContainer.style.display = 'none';
                mainReport.style.display = 'block';
                const today = new Date().toLocaleDateString('pt-BR', {timeZone: 'America/Sao_Paulo'}).split('/').reverse().join('-');
                dateInput.value = today;
                generateReport(today);
                loadCashData(today);
            } else {
                mainReport.style.display = 'none';
                loginContainer.style.display = 'flex';
                const loginButton = loginForm.querySelector('button');
                if (loginButton) loginButton.textContent = 'Acessar';
            }
        });

        async function generateReport(dateString) {
            const localDate = new Date(dateString + 'T03:00:00');
            const startOfDay = Timestamp.fromDate(new Date(localDate.setHours(0, 0, 0, 0)));
            const endOfDay = Timestamp.fromDate(new Date(localDate.setHours(23, 59, 59, 999)));
            const q = query(collection(db, "pedidos"), where("timestamp", ">=", startOfDay), where("timestamp", "<=", endOfDay));
            
            try {
                const querySnapshot = await getDocs(q);
                let totalSales = 0, totalOrders = 0, cancelledOrders = 0, totalDinheiro = 0;
                const paymentCounts = { 'PIX': 0, 'Cartao na Entrega': 0, 'Dinheiro': 0 };
                const deliveryCounts = { 'Entrega': 0, 'Retirada': 0 };
                const itemCounts = {};

                if (querySnapshot.empty) {
                    reportGrid.style.display = 'none';
                    noDataMessage.style.display = 'block';
                    updateAllCharts(paymentCounts, deliveryCounts, itemCounts);
                } else {
                    reportGrid.style.display = 'grid';
                    noDataMessage.style.display = 'none';
                    querySnapshot.forEach(doc => {
                        const order = doc.data();
                        if (order.status === 'Cancelado') {
                            cancelledOrders++;
                        } else if (order.status === 'Conclu√≠do' || order.status === 'Saiu para Entrega') {
                            totalSales += (order.total || 0);
                            totalOrders++;
                            if(paymentCounts.hasOwnProperty(order.paymentMethod)) paymentCounts[order.paymentMethod]++;
                            if(deliveryCounts.hasOwnProperty(order.deliveryMethod)) deliveryCounts[order.deliveryMethod]++;
                            if (order.paymentMethod === 'Dinheiro') totalDinheiro += order.total;
                            if (order.items && Array.isArray(order.items)) {
                                order.items.forEach(item => {
                                    itemCounts[item.name] = (itemCounts[item.name] || 0) + item.quantity;
                                });
                            }
                        }
                    });
                }
                
                const averageTicket = totalOrders > 0 ? totalSales / totalOrders : 0;
                document.getElementById('total-sales').textContent = `R$ ${totalSales.toFixed(2)}`;
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('cancelled-orders').textContent = cancelledOrders;
                document.getElementById('average-ticket').textContent = `R$ ${averageTicket.toFixed(2)}`;
                updateAllCharts(paymentCounts, deliveryCounts, itemCounts);
                
                cashSalesSpan.textContent = totalDinheiro.toFixed(2);
                calculateCash();
                
                const formattedDate = new Date(dateString + 'T03:00:00').toLocaleDateString('pt-BR');
                document.getElementById('print-date').textContent = formattedDate;
                document.getElementById('print-total-sales').textContent = totalSales.toFixed(2);
                document.getElementById('print-total-orders').textContent = totalOrders;
                document.getElementById('print-cancelled-orders').textContent = cancelledOrders;
                document.getElementById('print-average-ticket').textContent = averageTicket.toFixed(2);
                document.getElementById('print-pix-count').textContent = paymentCounts['PIX'];
                document.getElementById('print-card-count').textContent = paymentCounts['Cartao na Entrega'];
                document.getElementById('print-money-count').textContent = paymentCounts['Dinheiro'];

            } catch (error) { console.error("Erro ao gerar relat√≥rio:", error); }
        }
        
        function updateAllCharts(paymentData, deliveryData, itemData) {
            updatePaymentChart(paymentData);
            updateBestsellersChart(itemData);
            updateDeliveryChart(deliveryData);
        }

        function updatePaymentChart(counts) {
            const ctx = document.getElementById('payment-chart').getContext('2d');
            if (paymentChart) paymentChart.destroy();
            paymentChart = new Chart(ctx, {
                type: 'doughnut', data: { labels: ['PIX', 'Cart√£o na Entrega', 'Dinheiro'], datasets: [{ label: 'Formas de Pagamento', data: [counts['PIX'], counts['Cartao na Entrega'], counts['Dinheiro']], backgroundColor: ['#2196F3', '#FFC107', '#4CAF50'], borderColor: '#333', borderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'white', font: { size: 14 } } } } }
            });
        }
        
        function updateBestsellersChart(counts) {
            const ctx = document.getElementById('bestsellers-chart').getContext('2d');
            if (bestsellersChart) bestsellersChart.destroy();
            const sortedItems = Object.entries(counts).sort(([,a],[,b]) => b - a);
            const labels = sortedItems.map(item => item[0]);
            const data = sortedItems.map(item => item[1]);
            bestsellersChart = new Chart(ctx, {
                type: 'bar', data: { labels, datasets: [{ label: 'Quantidade Vendida', data, backgroundColor: 'rgba(255, 193, 7, 0.8)', borderColor: 'rgba(255, 193, 7, 1)', borderWidth: 1 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => ` Vendidos: ${c.raw}` } } }, scales: { x: { ticks: { color: 'white' } }, y: { ticks: { color: 'white', font: {size: 14} } } } }
            });
        }
        
        function updateDeliveryChart(counts) {
            const ctx = document.getElementById('delivery-chart').getContext('2d');
            if (deliveryChart) deliveryChart.destroy();
            deliveryChart = new Chart(ctx, {
                type: 'doughnut', data: { labels: ['Entrega', 'Retirada'], datasets: [{ data: [counts['Entrega'], counts['Retirada']], backgroundColor: ['#2196F3', '#4CAF50'], borderColor: '#333', borderWidth: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { color: 'white', font: { size: 14 } } } } }
            });
        }

        async function loadCashData(dateString) {
            const prevDate = new Date(dateString + 'T03:00:00');
            prevDate.setDate(prevDate.getDate() - 1);
            const prevDateString = prevDate.toISOString().split('T')[0];
            const prevDocRef = doc(db, "caixa", prevDateString);
            const prevDocSnap = await getDoc(prevDocRef);
            prevDayClosingSpan.textContent = prevDocSnap.exists() ? (prevDocSnap.data().fechamento || 0).toFixed(2) : "0.00";
            const docRef = doc(db, "caixa", dateString);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                cashStartInput.value = docSnap.data().abertura || '';
                cashEndInput.value = docSnap.data().fechamento || '';
            } else {
                cashStartInput.value = '';
                cashEndInput.value = '';
            }
            calculateCash();
        }

        function calculateCash() {
            const start = parseFloat(cashStartInput.value) || 0;
            const sales = parseFloat(cashSalesSpan.textContent) || 0;
            const end = parseFloat(cashEndInput.value) || 0;
            const expected = start + sales;
            const diff = end - expected;
            cashExpectedSpan.textContent = expected.toFixed(2);
            cashDiffSpan.textContent = `${diff.toFixed(2)}`;
            cashDiffSpan.className = diff < 0 ? 'negative' : (diff > 0 ? 'positive' : '');
        }

        async function saveCashData() {
            const dateString = dateInput.value;
            if (!dateString) { alert('Por favor, selecione uma data.'); return; }
            const docRef = doc(db, "caixa", dateString);
            const data = { abertura: parseFloat(cashStartInput.value) || 0, fechamento: parseFloat(cashEndInput.value) || 0 };
            try {
                await setDoc(docRef, data, { merge: true });
                alert('Dados do caixa salvos com sucesso!');
            } catch (error) {
                alert('Erro ao salvar os dados do caixa.');
                console.error("Erro ao salvar caixa:", error);
            }
        }

        exportPdfBtn.addEventListener('click', () => {
            const reportElement = document.getElementById('print-version');
            const selectedDate = dateInput.value;
            const options = { margin: [0.5, 0.5, 0.5, 0.5], filename: `relatorio-vendas-${selectedDate}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            reportElement.style.display = 'block';
            html2pdf().from(reportElement).set(options).save().then(() => {
                reportElement.style.display = 'none';
            });
        });

        dateInput.addEventListener('change', () => {
            generateReport(dateInput.value);
            loadCashData(dateInput.value);
        });
        
        cashStartInput.addEventListener('input', calculateCash);
        cashEndInput.addEventListener('input', calculateCash);
        saveCashBtn.addEventListener('click', saveCashData);
        togglePrevDayBtn.addEventListener('click', () => {
            prevDayInfo.style.display = prevDayInfo.style.display === 'block' ? 'none' : 'block';
        });
    </script>
</body>
</html>